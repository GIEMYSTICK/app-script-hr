<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ลงเวลาเข้างาน</title>
    <style>
      #loader-overlay {
        display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5);
        z-index: 50; display: flex; flex-direction: column; 
        align-items: center; justify-content: center;
      }
      #loader {
        border: 6px solid #f3f3f3; border-top: 6px solid #3498db; border-radius: 50%;
        width: 50px; height: 50px; animation: spin 1.2s linear infinite;
      }
      #loader-text { color: white; margin-top: 16px; font-size: 1.1rem; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .hidden-button { display: none; }
    </style>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="loader-overlay" style="display: none;">
      <div id="loader"></div>
      <div id="loader-text">กำลังบันทึกข้อมูล...</div>
    </div>

    <div id="app-container" class="max-w-sm w-full mx-auto p-4">
      <div class="bg-white rounded-xl shadow-lg p-6">
        
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-4">
          ระบบลงเวลาเข้างาน
        </h1>
        
        <div class="text-center mb-6 p-4 bg-blue-50 rounded-lg">
          <p class="text-xl font-semibold text-blue-700">
            <?= employee.name ?> (<?= employee.nickname ?>)
          </p>
          <p class="text-gray-600">ID: <?= employee.id ?></p>
          <p class="text-gray-500 text-sm"><?= employee.department ?></p>
        </div>
        
        <div class="flex flex-col space-y-3">
          <button id="clockInMorningBtn" class="hidden-button bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-lg shadow-md transition duration-200">
            เข้างาน (กะเช้า)
          </button>
          <button id="clockInAfternoonBtn" class="hidden-button bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg shadow-md transition duration-200">
            เข้างาน (กะบ่าย)
          </button>
          <button id="startBreakBtn" class="hidden-button bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg text-lg shadow-md transition duration-200">
            เริ่มพัก
          </button>
          <button id="endBreakBtn" class="hidden-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg shadow-md transition duration-200">
            กลับจากพัก
          </button>
          <button id="clockOutBtn" class="hidden-button bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg text-lg shadow-md transition duration-200">
            เลิกงาน
          </button>
        </div>

        <div id="status" class="mt-4 text-center text-sm font-medium">
          <!-- ข้อความสถานะจะแสดงที่นี่ -->
        </div>

      </div>
    </div>

    <input type="hidden" id="empId" value="<?= empId ?>">
    <input type="hidden" id="currentStatus" value="<?= currentStatus ?>">
    <input type="hidden" id="officeLat" value="<?= officeLat ?>">
    <input type="hidden" id="officeLng" value="<?= officeLng ?>">
    <input type="hidden" id="officeRadius" value="<?= officeRadius ?>">

    <script>
      const empId = document.getElementById("empId").value;
      const initialStatus = document.getElementById("currentStatus").value;
      const officeLat = parseFloat(document.getElementById("officeLat").value);
      const officeLng = parseFloat(document.getElementById("officeLng").value);
      const officeRadius = parseFloat(document.getElementById("officeRadius").value);
      
      const clockInMorningBtn = document.getElementById("clockInMorningBtn");
      const clockInAfternoonBtn = document.getElementById("clockInAfternoonBtn");
      const startBreakBtn = document.getElementById("startBreakBtn"); 
      const endBreakBtn = document.getElementById("endBreakBtn");     
      const clockOutBtn = document.getElementById("clockOutBtn");
      
      const statusDiv = document.getElementById("status");
      const loaderOverlay = document.getElementById("loader-overlay");
      const loaderText = document.getElementById("loader-text");

      let pendingAction = null;

      clockInMorningBtn.addEventListener("click", () => checkLocation("เข้างาน (กะเช้า)"));
      clockInAfternoonBtn.addEventListener("click", () => checkLocation("เข้างาน (กะบ่าย)"));
      startBreakBtn.addEventListener("click", () => checkLocation("เริ่มพัก"));
      endBreakBtn.addEventListener("click", () => checkLocation("กลับจากพัก"));
      clockOutBtn.addEventListener("click", () => checkLocation("เลิกงาน"));

      function checkLocation(action) {
        pendingAction = action; 
        if (!("geolocation" in navigator)) {
          onFailure({ message: "เบราว์เซอร์ของคุณไม่รองรับการระบุตำแหน่ง" });
          return;
        }
        showLoading(true, "กำลังตรวจสอบตำแหน่ง...");
        disableButtons(true);
        statusDiv.textContent = "กรุณารอสักครู่ กำลังตรวจสอบพิกัด...";
        statusDiv.className = "mt-4 text-center text-sm font-medium text-gray-600";
        navigator.geolocation.getCurrentPosition(
          onLocationSuccess, onLocationError,   
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      }

      function onLocationSuccess(position) {
        const userLat = position.coords.latitude;
        const userLng = position.coords.longitude;
        const distance = calculateDistance(userLat, userLng, officeLat, officeLng);

        if (distance <= officeRadius) {
          statusDiv.textContent = "ตำแหน่งถูกต้อง! กำลังบันทึกเวลา...";
          recordTimeOnServer(pendingAction, userLat, userLng, distance);
        } else {
          onFailure({ message: `คุณอยู่นอกพื้นที่ที่กำหนด (ระยะห่าง: ${distance.toFixed(0)} ม.)` });
        }
      }

      function onLocationError(error) {
        let errorMsg = "ไม่สามารถดึงตำแหน่งได้";
        if (error.code === 1) errorMsg = "คุณปฏิเสธการเข้าถึงตำแหน่ง (กรุณาอนุญาต)";
        else if (error.code === 2) errorMsg = "ไม่สามารถเชื่อมต่อ GPS ได้ (สัญญาณไม่ดี)";
        else if (error.code === 3) errorMsg = "หมดเวลาในการค้นหาตำแหน่ง";
        onFailure({ message: errorMsg });
      }

      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; 
        const phi1 = lat1 * Math.PI / 180;
        const phi2 = lat2 * Math.PI / 180;
        const deltaPhi = (lat2 - lat1) * Math.PI / 180;
        const deltaLambda = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
                  Math.cos(phi1) * Math.cos(phi2) *
                  Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      function recordTimeOnServer(action, lat, lng, dist) {
        showLoading(true, "กำลังบันทึกข้อมูล..."); 
        google.script.run
          .withSuccessHandler(onRecordSuccess)
          .withFailureHandler(onFailure)
          .recordTime(empId, action, lat, lng, dist);
      }

      function onRecordSuccess(response) {
        showLoading(false);
        if (response.status === 'success') {
          statusDiv.textContent = response.message;
          statusDiv.className = "mt-4 text-center text-sm font-medium text-green-600";
          updateUI(response.newState); 
          disableButtons(false); 
        } else {
          onFailure({ message: response.message });
        }
      }

      function onFailure(error) {
        showLoading(false); 
        disableButtons(false); 
        statusDiv.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
        statusDiv.className = "mt-4 text-center text-sm font-medium text-red-600";
        pendingAction = null; 
      }

      function updateUI(status) {
        clockInMorningBtn.style.display = 'none'; 
        clockInAfternoonBtn.style.display = 'none'; 
        startBreakBtn.style.display = 'none';
        endBreakBtn.style.display = 'none';
        clockOutBtn.style.display = 'none';

        if (status === "ClockedOut") {
          clockInMorningBtn.style.display = 'block'; 
          clockInAfternoonBtn.style.display = 'block'; 
        } else if (status === "ClockedIn") {
          startBreakBtn.style.display = 'block';
          clockOutBtn.style.display = 'block';
        } else if (status === "OnBreak") {
          endBreakBtn.style.display = 'block';
        } else if (status === "OnLeaveOrAbsent") {
          statusDiv.textContent = "สถานะของคุณถูกบันทึกโดย HR แล้วสำหรับวันนี้";
          statusDiv.className = "mt-4 text-center text-sm font-medium text-blue-600";
        }
      }

      function showLoading(isLoading, text = "กำลังบันทึกข้อมูล...") {
        loaderText.textContent = text; 
        loaderOverlay.style.display = isLoading ? "flex" : "none";
      }

      function disableButtons(isDisabled) {
        const buttons = [clockInMorningBtn, clockInAfternoonBtn, startBreakBtn, endBreakBtn, clockOutBtn];
        buttons.forEach(btn => {
          btn.disabled = isDisabled;
          btn.classList.toggle('opacity-50', isDisabled);
          btn.classList.toggle('cursor-not-allowed', isDisabled);
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        updateUI(initialStatus);
      });
    </script>
  </body>
</html>
